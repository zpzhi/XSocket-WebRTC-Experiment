(function(){for(var i=0,t=["webkit","moz"],n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(n){var t=(new Date).getTime(),r=Math.max(0,16-(t-i)),u=window.setTimeout(function(){n(t+r)},r);return i=t+r,u});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(n){clearTimeout(n)})})();var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;navigator.mozGetUserMedia?(webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),createIceServer=function(n,t,i){var r=null,f=n.split(":"),u;return f[0].indexOf("stun")===0?r={url:n}:f[0].indexOf("turn")===0&&(webrtcDetectedVersion<27?(u=n.split("?"),u[1].indexOf("transport=udp")===0&&(r={url:u[0],credential:i,username:t})):r={url:n,credential:i,username:t}),r},attachMediaStream=function(n,t){n.mozSrcObject=t;n.play()},reattachMediaStream=function(n,t){n.mozSrcObject=t.mozSrcObject;n.play()}):navigator.webkitGetUserMedia?(webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),createIceServer=function(n,t,i){var r=null,u=n.split(":");return u[0].indexOf("stun")===0?r={url:n}:u[0].indexOf("turn")===0&&(r={url:n,credential:i,username:t}),r},RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(n,t){typeof n.srcObject!="undefined"?n.srcObject=t:typeof n.mozSrcObject!="undefined"?n.mozSrcObject=t:typeof n.src!="undefined"?n.src=URL.createObjectURL(t):console.log("Error attaching stream to element.")},reattachMediaStream=function(n,t){n.src=t.src}):console.log("Browser does not appear to be WebRTC-capable");window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)}}();XSockets.PeerContext=function(n,t){this.PeerId=n;this.Context=t};window.AudioContext=window.AudioContext||window.webkitAudioContext;window.URL=window.URL||window.webkitURL;XSockets.AudioAnalyser=function(){function n(n,t,i){function o(n,t){var a=4,v=1e3,f=1e3,h=-1,s=0,e=0,y=0,c,o,u,i,l;if(!(n.length<f+v-a)){for(i=0;i<f;i++)c=(n[i]-128)/128,e+=c*c;for(o=a;o<=v;o++){for(u=0,i=0;i<f;i++)u+=Math.abs((n[i]-128)/128-(n[i+o]-128)/128);u=1-u/f;u>s&&(s=u,h=o)}if(e=Math.sqrt(e/f),e>.01&&s>.01){if(y=t/h,l={confidence:s,currentPitch:y,fequency:t/h,rms:e,timeStamp:new Date},r.onresult)r.onresult(l);r.analyzerResult.unshift(l)}}}function s(){r.analyser.getByteTimeDomainData(f);o(f,r.audioContext.sampleRate)}var r=this,f=new Uint8Array(2048),u=!1,e;this.analyzerResult=[];this.isSpeaking=!1;this.onResult=undefined;this.onAnalysis=undefined;this.audioContext=new AudioContext;e=this.audioContext.createMediaStreamSource(n);this.analyser=this.audioContext.createAnalyser();this.analyser.smoothingTimeConstant=.8;this.analyser.fftSize=2048;e.connect(this.analyser);this.byteFrequencyData=function(){var n=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteFrequencyData(n),n};this.enabled=function(n){u=n||!u};window.setInterval(function(){u&&s()},(t||1e3)/10);setInterval(function(){if(u&&r.analyzerResult.length>5){var t=new Date,n=r.analyzerResult[0],i=new Date(r.analyzerResult[0].timeStamp.getTime());if(t-i>1e3){if(r.isSpeaking){if(n.isSpeaking=!1,r.onanalysis)r.onanalysis(n);r.analyzerResult=[]}r.isSpeaking=!1}else{if(!r.isSpeaking&&(n.isSpeaking=!0,r.onanalysis))r.onanalysis(n);r.isSpeaking=!0}}},250);i&&i()}return n}();XSockets.WebRTC=function(){return function(n,t){var h,f;if(n instanceof XSockets.Controller==!1)throw"you most provide a controller controller";var e=!1,r=this,u=[],o=[],s=new XSockets.Subscriptions;this.presense=new XSockets.WebRTC.PresenceManager(n);this.PeerConnections={};this.DataChannels=undefined;h={iceServers:[{url:"stun:stun.l.google.com:19302"}],sdpConstraints:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},streamConstraints:{mandatory:{},optional:[]},sdpExpressions:[]};f=XSockets.Utils.extend(h,t);this.addIceServers=function(n){n.forEach(function(n){f.iceServers.push(n)})};this.userMediaConstraints=new XSockets.UserMediaConstraints;this.bind=function(n,t){return s.add(new XSockets.Subscription(n,t)),this};this.getSubscriptions=function(){return s};this.unbind=function(n,t){return s.remove(n),t&&typeof t=="function"&&t(),this};this.dispatch=function(n,t){var i=s.get(function(t){return t.topic===n}),u;i&&i.fire(t);u=Object.keys(r).filter(function(t){return t==="on"+n});u.forEach(function(n){r.hasOwnProperty(n)&&r[n](t)})};this.supportsMediaSources=function(){return typeof MediaStreamTrack=="undefined"};this.muteAudio=function(n){u.forEach(function(n){var t=n.getAudioTracks();if(t.length!==0)if(e)for(i=0;i<t.length;i++)t[i].enabled=!0;else for(i=0;i<t.length;i++)t[i].enabled=!1});e=!e;n&&n(e)};this.hasStream=function(){return u.length>0};this.leaveContext=function(){return n.invoke("leaveContext"),this};this.changeContext=function(t){n.invoke("changecontext",{context:t});for(var i in this.PeerConnections)this.PeerConnections[i].Connection.close(),r.dispatch(XSockets.WebRTC.Events.onconnectionlost,{PeerId:i}),delete this.PeerConnections[i];return this};this.connectToContext=function(){for(var t in this.PeerConnections)this.PeerConnections[t].Connection.close(),delete this.PeerConnections[t];return n.invoke("connectToContext"),this};this.getLocalStreams=function(){return u};this.removeStream=function(t,i){u.forEach(function(f,e){if(f.id===t){u.splice(e,1);for(var o in r.PeerConnections)r.PeerConnections[o].Connection.removeStream(f),n.invoke("removestream",{recipient:o,streamId:t}),i&&i(t)}})};this.getRemoteStreams=function(){return o};this.removeAllStreams=function(){o.forEach(function(n){r.dispatch(XSockets.WebRTC.Events.remoteStreams,n)})};this.getRemotePeers=function(){var n=[];for(var t in r.PeerConnections)n.push(t);return n};this.refreshStreams=function(n,t){u.forEach(function(t,i){r.PeerConnections[n].Connection.removeStream(u[i])});r.createOffer({PeerId:n});t&&t(n)};this.addLocalStream=function(t,i){var f,e;t.id||(t.id=XSockets.Utils.guid());for(f in r.PeerConnections)r.PeerConnections[f].Connection.addStream(t);return e=u.push(t),n.invoke("addStream",{streamId:t.id,description:""}),r.dispatch(XSockets.WebRTC.Events.onlocalstream,t),i&&i(t,e),this};this.removePeerConnection=function(n,t){if(r.PeerConnections[n]!==undefined)try{r.PeerConnections[n].Connection.close();r.dispatch(XSockets.WebRTC.Events.onconnectionlost,{PeerId:n})}catch(i){}delete r.PeerConnections[n];t&&t()};this.getUserMedia=function(t,i,f){return t instanceof XSockets.UserMediaConstraint&&delete t.applySources,window.getUserMedia(t,function(t){t.id||(t.id=XSockets.Utils.guid());u.push(t);n.invoke("addStream",{streamId:t.id,description:""});r.dispatch(XSockets.WebRTC.Events.onlocalstream,t);i&&typeof i=="function"&&i(r.CurrentContext)},function(n){n&&typeof n=="function"&&f(n);r.onerror(n)}),this};this.addDataChannel=function(n){if(this.DataChannels=this.DataChannels||{},this.DataChannels.hasOwnProperty(n.name))throw"A RTCDataChannel named '"+n.Name+"' already exists and cannot be created.";else this.DataChannels[n.name]=n};this.removeDataChannel=function(n){if(this.DataChannels.hasOwnProperty(n)){delete this.DataChannels[n];for(var t in this.PeerConnections)this.PeerConnections[t].RTCDataChannels[n].close(),delete this.PeerConnections[t].RTCDataChannels[n]}else throw"A RTCDataChannel named '"+n+"' does not exists.";};this.onerror=function(n){console.log(n)};this.Connections=[];this.rtcPeerConnection=function(t,i,u){var e=this,s,h,f;this.PeerId=i;this.RTCDataChannels={};u&&u(i);s={};(webrtcDetectedBrowser==="chrome"&&webrtcDetectedVersion<=31||webrtcDetectedBrowser==="firefox")&&typeof r.DataChannels=="object"&&t.sdpConstraints.optional.push({RtpDataChannels:!0});this.Connection=new RTCPeerConnection({iceServers:t.iceServers||{},rtcpMuxPolicy:"require",bundlePolicy:"max-bundle"},null);this.Connection.oniceconnectionstatechange=function(n){e.Connection.iceConnectionState==="disconnected"?r.dispatch(XSockets.WebRTC.Events.onconnectionlost,{PeerId:e.PeerId}):e.Connection.iceConnectionState==="connected"&&r.dispatch(XSockets.WebRTC.Events.onconnectioncreated,{PeerId:e.PeerId});r.dispatch(n.type,n)};this.Connection.onnegotiationneeded=function(n){r.dispatch(n.type,n)};this.Connection.onremovestream=function(n){r.dispatch(n.type,n)};this.Connection.onsignalingstatechange=function(n){r.dispatch(n.type,n)};for(h in r.DataChannels)f=r.DataChannels[h],this.RTCDataChannels[f.name]=this.Connection.createDataChannel(f.name,t.dataChannelConstraints),this.Connection.ondatachannel=function(n){var t=n.channel;t.onmessage=function(n){var i=f.subscriptions,t,r;typeof n.data=="string"?(t=JSON.parse(n.data),i.get(function(n){return n.topic==t.T}).fire(t.D)):(r=new XSockets.BinaryMessage,r.extractMessage(n.data,function(n){var t=n.topic;i.get(function(n){return n.topic==t}).fire(n)}))};t.onopen=function(n){if(f.onopen)f.onopen(e.PeerId,n.target)};t.onclose=function(n){if(f.onclose)f.onclose(e.PeerId,n.target)};s[n.label]=n.channel},f.onpublishbinary=function(n,t,i){var u,e,o;for(u in r.PeerConnections)r.PeerConnections[u].RTCDataChannels[f.name].readyState==="open"&&(e=new XSockets.Message(n,i||{},f.name),o=new XSockets.BinaryMessage(e,t,function(n){console.log(n);r.PeerConnections[u].RTCDataChannels[f.name].send(n.buffer)}))},f.onpublishbinaryTo=function(n,t,i,u){var e=new XSockets.Message(t,u||{},f.name),o;r.PeerConnections[n]&&(o=new XSockets.BinaryMessage(e,i,function(t){r.PeerConnections[n].RTCDataChannels[f.name].send(t.buffer)}))},f.onpublish=function(n,t){var u=new XSockets.Message(n,t);for(var i in r.PeerConnections)r.PeerConnections[i].RTCDataChannels[f.name].readyState==="open"&&r.PeerConnections[i].RTCDataChannels[f.name].send(JSON.stringify(u))},f.onpublishTo=function(n,t,i){var u=new XSockets.Message(t,i);r.PeerConnections[n]&&r.PeerConnections[n].RTCDataChannels[f.name].send(JSON.stringify(u))};this.Connection.onaddstream=function(n){var t=o.findIndex(function(t){return t.id===n.stream.id});t===-1&&(o.push({id:n.stream.id,peerId:e.PeerId}),r.dispatch(XSockets.WebRTC.Events.onremotestream,{PeerId:e.PeerId,stream:n.stream}))};this.Connection.onicecandidate=function(t){if(t.candidate){var i={type:"candidate",label:t.candidate.sdpMLineIndex,id:t.candidate.sdpMid,candidate:t.candidate.candidate};n.invoke("contextsignal",{sender:r.CurrentContext.PeerId,recipient:e.PeerId,message:JSON.stringify(i)})}}};this.createOffer=function(t){t&&(r.PeerConnections[t.PeerId]=new r.rtcPeerConnection(f,t.PeerId),u.forEach(function(n){r.PeerConnections[t.PeerId].Connection.addStream(n,f.streamConstraints)}),r.PeerConnections[t.PeerId].Connection.createOffer(function(i){f.sdpExpressions.forEach(function(n){i.sdp=n(i.sdp)},function(n){r.onerror(n)});r.PeerConnections[t.PeerId].Connection.setLocalDescription(i);n.invoke("contextsignal",{Sender:r.CurrentContext.PeerId,Recipient:t.PeerId,Message:JSON.stringify(i)})},function(n){r.onerror(n)},f.sdpConstraints))};r.bind("connect",function(n){r.createOffer(n)});r.bind("candidate",function(n){var t=JSON.parse(n.Message);r.PeerConnections[n.Sender]&&r.PeerConnections[n.Sender].Connection.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:t.label,candidate:t.candidate}))});r.bind("answer",function(n){r.dispatch(XSockets.WebRTC.Events.onanwer,{PeerId:n.Sender});r.PeerConnections[n.Sender].Connection.setRemoteDescription(new RTCSessionDescription(JSON.parse(n.Message)))});r.bind("offer",function(t){r.dispatch(XSockets.WebRTC.Events.onoffer,{PeerId:t.Sender});r.PeerConnections[t.Sender]=new r.rtcPeerConnection(f,t.Sender);r.PeerConnections[t.Sender].Connection.setRemoteDescription(new RTCSessionDescription(JSON.parse(t.Message)));u.forEach(function(n){r.PeerConnections[t.Sender].Connection.addStream(n,f.streamConstraints)});r.PeerConnections[t.Sender].Connection.createAnswer(function(i){r.PeerConnections[t.Sender].Connection.setLocalDescription(i);f.sdpExpressions.forEach(function(n){i.sdp=n(i.sdp)},function(n){r.onerror(n)});var u={Sender:r.CurrentContext.PeerId,Recipient:t.Sender,Message:JSON.stringify(i)};n.invoke("contextsignal",u)},function(n){r.onerror(n)},f.sdpConstraints)});n.contextcreated=function(n){r.CurrentContext=new XSockets.PeerContext(n.PeerId,n.Context);r.dispatch(XSockets.WebRTC.Events.oncontextcreated,n)};n.contextsignal=function(n){var t=JSON.parse(n.Message);r.dispatch(t.type,n)};n.contextchanged=function(n){r.dispatch(XSockets.WebRTC.Events.oncontextchange,n)};n.contextconnect=function(n){n.forEach(function(n){r.dispatch("connect",n);r.dispatch(XSockets.WebRTC.Events.onconnectionstart,n)})};n.connectiondisconnect=function(n){delete r.PeerConnections[n.Sender]};n.streamadded=function(n){r.dispatch(XSockets.WebRTC.Events.onlocalstreamcreated,n)};n.streamremoved=function(n){r.dispatch(XSockets.WebRTC.Events.onremotestreamlost,{PeerId:n.Sender,StreamId:n.StreamId})};n.connectionlost=function(){}}}();XSockets.WebRTC.PresenceManager=function(){return function(n){this.Availability={Available:"Available",Away:"Away",DoNotDisturb:"DoNotDisturb"};this.instanceId=XSockets.Utils.guid();this.setUsername=function(t,i){n.invoke("SetUsername",{username:t});i&&i(t)};this.setAvailability=function(t,i){n.invoke("SetAvailability",{availability:Object.keys(this.Availability).indexOf(t)});i&&i(t)};this.parse=function(n){var t=Object.keys(this.Availability);return t[n].toLowerCase()}}}();XSockets.WebRTC.MediaSource=function(){return function(){this.getSources=function(n){return typeof MediaStreamTrack=="undefined"?(console.log("This browser does not support MediaStreamTrack"),null):(window.MediaStreamTrack.getSources(function(t){var i=t.map(function(n,t){return{id:n.id,kind:n.kind,label:n.label||n.kind+" - "+t}});n(i)}),this)}}}();XSockets.UserMediaConstraints=function(){return function(){this.options=["qvga","vga","hd"];this.audioOnly=function(){return new XSockets.UserMediaConstraint({video:!1,audio:!0})};this.qvga=function(n){return new XSockets.UserMediaConstraint({video:{mandatory:{maxWidth:320,maxHeight:180}},audio:typeof n!="boolean"?!1:n})};this.svga=function(n){return new XSockets.UserMediaConstraint({video:{mandatory:{maxWidth:800,maxHeight:600},optional:[]},audio:typeof n!="boolean"?!1:n})};this.xga=function(n){return new XSockets.UserMediaConstraint({video:{mandatory:{maxWidth:1024,maxHeight:768},optional:[]},audio:typeof n!="boolean"?!1:n})};this.vga=function(n){return new XSockets.UserMediaConstraint({video:{mandatory:{maxWidth:640,maxHeight:360},optional:[]},audio:typeof n!="boolean"?!1:n})};this.hd=function(n){return new XSockets.UserMediaConstraint({video:{mandatory:{minWidth:1280,minHeight:720},optional:[]},audio:typeof n!="boolean"?!1:n})};this.create=function(n,t,i){return new XSockets.UserMediaConstraint({video:{mandatory:{minWidth:n,minHeight:t}},optional:[],audio:typeof i!="boolean"?!1:i})}}}();XSockets.WebRTC.AudioPlayer=function(){function n(){this.audioBuffers={};this.keys=[];this.context=new AudioContext;this.sources={}}return n.prototype.load=function(n,t,i){var u=this,r;return this.keys.unshift(n),r=new XMLHttpRequest,r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){u.context.decodeAudioData(r.response,function(t){u.audioBuffers[n]=t;i&&i(n);u.completed&&u.completed(n)},function(n){u.error(n)})},r.send(),this},n.prototype.createBuffer=function(n,t){var u=this,i,r;this.keys.unshift(n);i=this.context.createBufferSource();r=this.context.createBuffer(t,!0);i.buffer=r;i.connect(context.destination);i.start(context.currentTime)},n.prototype.error=function(){console.error(error)},n.prototype.completed=function(){},n.prototype.play=function(n){return this.sources[n]=this.context.createBufferSource(),this.sources[n].buffer=this.audioBuffers[n],this.sources[n].connect(this.context.destination),this.sources[n].start?this.sources[n].start():this.sources[n].noteOn(0),this},n.prototype.pause=function(n){this.sources[n].stop(0)},n}();XSockets.WebRTC.VoiceMessage=function(){var t,n=function(n){var t=this;if(!1 in window)throw"You need to reference Matt Diamons recorderJS,https://github.com/mattdiamond/Recorderjs";this.audioContext=new AudioContext;this.input=null;n=n||{maxRecordingTime:4e3};this.created=null;this.isRecording=!1;this.loop=function(){if(t.isRecording){var i=new Date,r=i-t.created;t.timeElapsed&&(t.timeElapsed(r,i,t.created),r>=n.maxRecordingTime&&(t.isRecording=!1,t.stop(),t.recordingElapsed()));t.isRecording&&requestAnimationFrame(t.loop)}}};return n.prototype.addSteam=function(n){this.input=this.audioContext.createMediaStreamSource(n);this.input.connect(this.audioContext.destination);t=new Recorder(this.input)},n.prototype.start=function(){return this.created=new Date,this.isRecording=!0,t.record(),requestAnimationFrame(this.loop),this},n.prototype.stop=function(){t.stop();var n=this;return t.exportWAV(function(t){var i,r=new FileReader;r.onload=function(){i=this.result;n.completed(i)};r.readAsArrayBuffer(t)}),this},n.prototype.recordingElapsed=function(){},n.prototype.timeElapsed=function(n){console.log(n)},n.prototype.completed=function(n){t.exportWAV(function(t){n(t)})},n}();XSockets.UserMediaConstraint=function(){return function(n){var t=this,i,r;if(this.applySources=function(){},arguments.length>2)for(i=1;i<arguments.length;i++)this.extend(t,arguments[i]);else for(r in n)t[r]=n[r];return this.applySources=function(n,i){return n!=""?t.video&&(t.video.optional=[]).push({sourceid:n}):t.video=!1,i!=""?t.audio&&(t.audio.optional=[]).push({sourceid:i}):t.audio=!1,this},this}}();XSockets.WebRTC.DataChannel=function(){function n(n){var t=this;this.subscriptions=new XSockets.Subscriptions;this.name=n;this.subscribe=function(n,i){return t.subscriptions.add(new XSockets.Subscription(n,i)),this};this.publishBinary=function(n,i,r){if(!t.onpublishbinary)return this;t.onpublishbinary(n,i,r);return this};this.publishBinaryTo=function(n,i,r,u){if(!t.onpublishbinaryTo)return this;t.onpublishbinaryTo(i,r,u);return this};this.publish=function(n,i,r){if(!t.onpublish)return this;t.onpublish(n,i);return r&&r(i),this};this.publishTo=function(n,i,r,u){if(!t.onpublishTo)return this;t.onpublishTo(n,i,r);return u&&u(r),this};this.unsubscribe=function(n,i){return t.subscriptions.remove(n),i&&i(),this};this.onpublish=undefined;this.onclose=undefined;this.onopen=undefined}return n}();XSockets.WebRTC.Events={onlocalstream:"localstream",onlocalstreamcreated:"streamadded",onremotestream:"remotestream",onremotestreamlost:"remotestreamlost",oncontextchange:"contextchanged",oncontextcreated:"contextcreated",onconnectionstart:"connectionstarted",onconnectioncreated:"connectioncreated",onconnectionlost:"connectionlost",onoffer:"sdoffer",onanwer:"sdanswer"};